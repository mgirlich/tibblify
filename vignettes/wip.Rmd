---
title: "Invariants"
author: "Maximilian Girlich"
date: "2022-06-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tibblify)
```

## Invariants

-   JSON roundtrip `tibblify(x) = tibblify(fromJSON(toJSON(x)))`

-   Guess all = guess elements and combine `spec_guess(x) = spec_common(!!!vec_map(x, spec_guess))`

-   `guess_spec(x$item)` should be the same as `guess_spec(x)$item`

## Supported input for `tibblify()`

There are three types of valid input to `tibblify()`:

1. Object

```{json}
{
  "a": 1,
  "b": true
}
```

The R equivalent is a named list where the names fulfill the requirements of
`vctrs::vec_as_names(repair = "check_unique")`

```{r}
x <- list(
  a = 1,
  b = TRUE
)
x
```

They can be parsed with `spec_object()` to produce a list

```{r}
object_spec <- spec_object(
  tib_int("a"),
  tib_lgl("b")
)
object_spec

tibblify(x, object_spec)
```

and with `spec_row()` to produce a 1 row tibble

```{r}
row_spec <- spec_row(
  tib_int("a"),
  tib_lgl("b")
)
row_spec

tibblify(x, row_spec)
```

2.  List of objects

```{json}
[
  {"a": 1, "b": true},
  {"b": 2, "b": false}
]
```


```{r}
list(
  list(a = 1, b = TRUE),
  list(a = 2, b = FALSE)
)
```

They are parsed with `spec_df()`

and the following form of fields are supported

+---------------------+------------------------------------+---------------------------------------+
| JSON                | R                                  | Spec                                  |
+=====================+====================================+=======================================+
| Scalar              | Length 1 vector                    | `tib_scalar()`                        |
|                     |                                    |                                       |
| ``` json            | ``` r                              | ``` r                                 |
| true                | TRUE                               | tib_lgl()                             |
| 1                   | 1                                  | tib_int()                             |
| 1.5                 | 1.5                                | tib_dbl()                             |
| "a"                 | "a"                                | tib_chr()                             |
| ```                 | ```                                | ```                                   |
|                     |                                    |                                       |
|                     | ``` r                              | ``` r                                 |
|                     | as.Date("2022-06-29")              | tib_scalar(ptype = vctrs::new_date()) |
|                     | ```                                | ```                                   |
|                     |                                    |                                       |
|                     | No JSON equivalent                 |                                       |
+---------------------+------------------------------------+---------------------------------------+
| Vector              | Vector                             | `tib_vector()`                        |
|                     |                                    |                                       |
| ``` json            | ``` r                              | ``` r                                 |
| [true, null, false] | c(TRUE, NA, FALSE)                 | tib_lgl_vec()                         |
| [1, null, 3]        | c(1L, NA, 2L)                      | tib_int_vec()                         |
| [1.5, null, 3.5]    | c(1.5, NA, 2.5)                    | tib_dbl_vec()                         |
| ["a", null, "c"]    | c("a", NA, "c")                    | tib_chr_vec()                         |
| ```                 | ```                                | ```                                   |
|                     |                                    |                                       |
|                     | Analogue to scalars                | Analogue to scalars                   |
+---------------------+------------------------------------+---------------------------------------+
|                     | List of scalars                    | `tib_vector()` with argument          |
|                     |                                    |                                       |
|                     | `fromJSON(simplifyVector = FALSE)` | `input_form = "scalar_list"`          |
|                     |                                    |                                       |
|                     | ``` r                              | ``` r                                 |
|                     | list(TRUE, NULL, FALSE)            | tib_lgl_vec(                          |
|                     | ```                                |   input_form = "scalar_list"          |
|                     |                                    | )                                     |
|                     |                                    | ```                                   |
+---------------------+------------------------------------+---------------------------------------+
| Object of scalars   | Named list of scalar               | `input_form = "object"`               |
|                     |                                    |                                       |
| ``` json            | ``` r                              | ``` r                                 |
| {                   | list(                              | tib_lgl_vec(                          |
|   "a": true,        |   a = TRUE,                        |   input_form = "object"               |
|   "b": null,        |   b = NA,                          | )                                     |
|   "c": false        |   c = FALSE                        | ```                                   |
| }                   | )                                  |                                       |
| ```                 | ```                                |                                       |
+---------------------+------------------------------------+---------------------------------------+
| Object              | Named list                         | `tib_row()`                           |
|                     |                                    |                                       |
| ``` json            | ``` r                              | ``` r                                 |
| {                   | list(                              | tib_row(                              |
|   "a": 1,           |   a = 1L,                          |   tib_int("a"),                       |
|   "b": "a",         |   b = "a",                         |   tib_chr("b"),                       |
|   "c": [1, 2, 3]    |   c = c(1L, 2L, 3L)                |   tib_int_vec("c")                    |
| }                   | )                                  | )                                     |
| ```                 | ```                                | ```                                   |
+---------------------+------------------------------------+---------------------------------------+
|                     |                                    |                                       |
+---------------------+------------------------------------+---------------------------------------+
|                     |                                    |                                       |
+---------------------+------------------------------------+---------------------------------------+
